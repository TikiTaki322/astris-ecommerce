{% extends 'core/base.html' %}

{% block content %}

<style>
  .card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transition: box-shadow 0.3s ease;
  }

  .payment-methods {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .payment-option {
    cursor: pointer;
    border: 2px solid #dee2e6;
    border-radius: 0.5rem;
    padding: 1rem;
    text-align: center;
    transition: border-color 0.2s ease, background-color 0.2s ease;
  }

  .payment-option:hover {
    border-color: #adb5bd;
  }

  .payment-option input:checked + strong {
    color: #198754;
  }

  .payment-option input:checked {
    display: none;
  }

  .payment-option:has(input:checked) {
    border-color: #198754;
    background-color: #f8fff9;
  }

</style>

<div class="container py-4">
    {% if price_diff %}
    <div class="alert alert-warning border-black text-center mx-auto"
         style="max-width: 732px;">
        Please note, the price of some items may have changed<br>
        <small class="text-muted">Prices are subject to change until checkout is complete</small>
    </div>
    {% elif message %}
    <div class="alert alert-warning border-black text-center mx-auto"
         style="max-width: 732px;">
        {{ message }}
    </div>
    {% endif %}

    {% if shipping_info and order %}
    <div class="row justify-content-center">
        <div class="col-12 col-sm-10 col-md-8 col-lg-7">
            <div class="card border-black p-4">
                <div class="card-body text-center">
                    <h3 class="mb-2">Review your order</h3>
                </div>

                <!-- Shipping Information -->
                <div class="mb-2">
                    <h5 class="mb-3">Shipping to:</h5>
                    <div class="ps-3">
                        <p class="mb-1">
                            <strong>{{ shipping_info.first_name }} {{ shipping_info.last_name }}</strong>
                        </p>
                        <p class="mb-2 text-muted">{{ shipping_info.email }}</p>
                        <p class="mb-1">{{ shipping_info.street }} {{ shipping_info.house_number }}</p>
                        <p class="mb-1">{{ shipping_info.city }}, {{ shipping_info.country }}</p>
                        <p class="mb-0 text-muted">Postal code: {{ shipping_info.postal_code }}</p>
                    </div>
                </div>

                <hr>

                <!-- Order Items -->
                <div class="mt-3">
                    <h5 class="mb-3">Order Items:</h5>
                    <ul class="list-group mb-3">
                        {% for item in order.items.all %}
                        <li class="list-group-item d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1 me-3" style="min-width: 0;">
                                <span class="d-block">{{ item.product_name }}</span>
                                <small>{{ item.product_quantity }} Ã— {{ item.product_unit_price }} CHF</small>
                            </div>
                            <div class="text-end" style="min-width: 80px; flex-shrink: 0;">
                                <span class="text-nowrap">{{ item.product_total_price }} CHF</span>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>

                <!-- Order Summary -->
                <div class="mt-3">
                    <h5 class="mb-3">Order Summary:</h5>
                    <ul class="list-group mb-3">
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Subtotal</span>
                            <span>{{ order.items_amount }} CHF</span>
                        </li>

                        <li class="list-group-item d-flex justify-content-between">
                            <span>Shipping</span>
                            <span>{{ order.delivery_amount}} CHF</span>
                        </li>

                        <li class="list-group-item d-flex justify-content-between fw-bold">
                            <span>Total</span>
                            <span>{{ order.total_amount }} CHF</span>
                        </li>
                    </ul>
                </div>

                <div class="d-flex justify-content-center gap-2 pt-4 mb-1">
                    <form method="post" action="{% url 'payments:start_payment' order.pk %}">
                        {% csrf_token %}

                        <div class="payment-methods">
                            {% for code, label in payment_methods %}
                            <label class="payment-option">
                                <input type="radio"
                                       name="payment_method"
                                       value="{{ code }}"
                                       required
                                       hidden>
                                <strong>{{ label }}</strong>
                            </label>
                            {% endfor %}
                        </div>

                        <div class="d-flex gap-2 pt-3">
                            <button type="submit"
                                    class="btn btn-outline-success"
                                    style="min-width: 120px;">
                                Pay now
                            </button>

                            <a href="{% url 'core:orderitem_list' %}"
                               class="btn btn-outline-dark"
                               style="min-width: 120px;">
                                Cancel
                            </a>
                        </div>
                    </form>
                </div>

            </div>
        </div>
    </div>
    {% endif %}
</div>

{% endblock %}