{% extends "core/base.html" %}

{% block content %}

<style>
    .card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transition: box-shadow 0.3s ease;
    }

    .card.hover-lift {
        transition: box-shadow 0.3s ease, transform 0.3s ease;
    }

    .card.hover-lift:hover {
        box-shadow: 0 0.75rem 1.25rem rgba(128, 128, 128, 0.3);
        transform: translateY(-3.5px);
    }

    .cart-card {
        overflow: hidden;
    }

    .cart-title {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        min-height: 2.5em;
        overflow: hidden;
    }

    .cart-item {
        font-size: 0.9rem;
        color: #5a6c7d;
    }

    .cart-item-image {
        height: 280px;
        object-fit: cover;
        background-color: #f8f9fa;
        transition: opacity 0.3s ease;
    }

    .cart-item-image-placeholder {
        height: 280px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        color: #6c757d;
    }

    .cart-item-image-container {
        position: relative;
        overflow: hidden;
    }

    .btn-delete-cart-item {
        color: white;
        background-color: #e95771;
    }
    .btn-delete-cart-item:hover {
        color: white;
        background-color: #e95771ad;
    }

    @media (max-width: 767.98px) {
        .cart-item-image,
        .cart-item-image-placeholder {
            height: 230px;
        }
    }

</style>

<div class="container py-4">
    <!-- Alert Messages -->
    {% if order_item_addition == "True" or order_item_deletion == "True" %}
        <div class="alert alert-success border-black text-center mx-auto"
             style="background: #fff; max-width: 700px;" role="alert">
            {{ message }}
        </div>
    {% elif order_item_addition == "False" or order_item_deletion == "False" %}
        <div class="alert alert-warning border-black text-center mx-auto"
             style="max-width: 700px;" role="alert">
            {{ message }}
        </div>
    {% endif %}

    {% if order %}
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">Your cart</h2>
            <form method="post" action="{% url 'core:cart_clear_out' %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-dark"
                    onclick="return confirm('Clear out the cart?');">
                    Empty the cart
                </button>
            </form>
        </div>

        <!-- Order Items-->
        <div class="row row-cols-2 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4">
            {% for order_item in order.items.all %}
            <div class="col">
                <div class="card border-black h-100 hover-lift cart-card">

                  <!-- Image -->
                    <div class="cart-item-image-container">
                        {% if order_item.product_image_url %}
                            <img src="{{ order_item.product_image_url }}"
                                 class="card-img-top cart-item-image">
                        {% else %}
                            <div class="cart-item-image-placeholder">
                                <span class="ms-2">No image</span>
                            </div>
                        {% endif %}
                    </div>

                    <!--Body-->
                    <div class="card-body d-flex flex-column p-3">
                        <h5 class="cart-title mb-3">{{ order_item.product_name }}</h5>
                        <ul class="list-group mb-3">
                            <li class="list-group-item d-flex justify-content-between cart-item px-2">
                                <span>Qty</span>
                                <span>{{ order_item.product_quantity }}</span>
                            </li>

                            <li class="list-group-item d-flex justify-content-between cart-item px-2">
                                <span>Unit</span>
                                <span>{{ order_item.product_unit_price }} CHF</span>
                            </li>

                            <li class="list-group-item d-flex justify-content-between cart-item fw-semibold px-2">
                                <span>Total</span>
                                <span>{{ order_item.product_total_price }} CHF</span>
                            </li>
                        </ul>

                        <form method="post"
                              action="{% url 'core:orderitem_delete' order_item.pk %}"
                              class="mt-auto">
                            {% csrf_token %}
                            <button type="submit"
                                    class="btn btn-delete-cart-item btn-sm w-100"
                                    onclick="return confirm('Remove product &quot;{{ order_item.product_name }}&quot;?');">
                                Remove
                            </button>
                        </form>

                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Order Summary-->
        <div class="card border-black mx-auto mt-4 mb-3" style="max-width: 720px">
            <div class="card-body d-flex flex-column">
                <div class="mt-2">
                    <h5 class="mb-4 text-center">Summary</h5>
                    <ul class="list-group mb-3">
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Subtotal</span>
                            <span>{{ order.items_amount }} CHF</span>
                        </li>

                        <li class="list-group-item d-flex justify-content-between">
                            <span>Shipping</span>
                            <div class="text-end">
                                {% if order.delivery_amount %}
                                    <span>{{ order.delivery_amount }} CHF</span>
                                    <p class="text-muted mb-0 small">
                                        Free Delivery from {{ settings.delivery_threshold }} CHF
                                    </p>
                                {% else %}
                                    <span>Free Delivery</span>
                                {% endif%}
                            </div>
                        </li>

                        <li class="list-group-item d-flex justify-content-between fw-bold">
                            <span>Total</span>
                            <span>{{ order.total_amount }} CHF</span>
                        </li>
                    </ul>
                </div>

                <div class="text-center align-items-center mt-3 mb-2">
                    <a href="{% url 'payments:start_checkout' %}" class="btn btn-dark">Proceed to checkout</a>
                </div>
            </div>
        </div>

    {% elif session_order %}
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">Your cart</h2>
            <form method="post" action="{% url 'core:cart_clear_out' %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-dark"
                    onclick="return confirm('Clear out the cart?');">
                    Empty the cart
                </button>
            </form>
        </div>

        <!-- SessionOrder Items-->
        <div class="row row-cols-2 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4">
            {% for pk, item in session_order.items.items %}
            <div class="col ">
                <div class="card border-black h-100 hover-lift cart-card">

                    <!-- Image -->
                    <div class="cart-item-image-container">
                        {% if item.product_image_url %}
                            <img src="{{ item.product_image_url }}"
                                 class="card-img-top cart-item-image">
                        {% else %}
                            <div class="cart-item-image-placeholder">
                                <span class="ms-2">No image</span>
                            </div>
                        {% endif %}
                    </div>

                    <!--Body-->
                    <div class="card-body d-flex flex-column p-3">
                        <h5 class="cart-title mb-3">{{ item.product_name }}</h5>
                        <ul class="list-group mb-3">
                            <li class="list-group-item d-flex justify-content-between cart-item px-2">
                                <span>Qty</span>
                                <span>{{ item.quantity }}</span>
                            </li>

                            <li class="list-group-item d-flex justify-content-between cart-item px-2">
                                <span>Unit</span>
                                <span>{{ item.unit_price }} CHF</span>
                            </li>

                            <li class="list-group-item d-flex justify-content-between cart-item fw-semibold px-2">
                                <span>Total</span>
                                <span>{{ item.total_price }} CHF</span>
                            </li>
                        </ul>

                        <!-- Action Buttons-->
                        <form method="post"
                              action="{% url 'core:orderitem_delete' pk %}"
                              class="mt-auto">
                            {% csrf_token %}
                            <button type="submit"
                                    class="btn btn-delete-cart-item btn-sm w-100"
                                    onclick="return confirm('Remove product &quot;{{ item.product_name }}&quot;?');">
                                Remove
                            </button>
                        </form>

                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- SessionOrder Summary-->
        <div class="card border-black mx-auto mt-4 mb-3" style="max-width: 720px;">
            <div class="card-body d-flex flex-column">
                <div class="mt-2">
                    <h5 class="mb-4 text-center">Summary</h5>
                    <ul class="list-group mb-3">
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Subtotal</span>
                            <span>{{ session_order.items_amount }} CHF</span>
                        </li>

                        <li class="list-group-item d-flex justify-content-between">
                            <span>Shipping</span>
                            <div class="text-end">
                                {% if session_order_delivery_amount %}
                                    <span>{{ session_order_delivery_amount }} CHF</span>
                                    <p class="text-muted mb-0 small">
                                        Free Delivery from {{ settings.delivery_threshold }} CHF
                                    </p>
                                {% else %}
                                    <span>Free Delivery</span>
                                {% endif %}
                            </div>
                        </li>

                        <li class="list-group-item d-flex justify-content-between fw-bold">
                            <span>Total</span>
                            <span>{{ session_order.total_amount }} CHF</span>
                        </li>
                    </ul>
                </div>

                <div class="text-center align-items-center mt-3 mb-2">
                    <a href="{% url 'payments:start_checkout' %}" class="btn btn-dark">Proceed to checkout</a>
                </div>
            </div>
        </div>

    {% else %}
        <div class="card card-body border-black mx-auto" style="max-width: 600px;">
            <div class="text-center">
                <h4 class="mb-2 mt-2">Your cart is empty</h4>
                <a href="{% url 'core:product_list' %}" class="btn btn-outline-dark mt-2 mb-1">
                    Back to Main Page
                </a>
            </div>
        </div>
    {% endif %}
</div>

{% endblock %}